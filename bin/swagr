#!/usr/bin/env ruby
require 'rubygems'
require 'thor'
require 'fileutils'

require 'swagr'

SwagrSourceRoot = File.dirname(__FILE__).split("/")[0...-1].join("/")

SkeletonDir = "skeletons"
DefaultSkeletonTarball = "bootstrap_default_130109_0842.zip"
SkeletonTarball = File.join(SkeletonDir, DefaultSkeletonTarball)

StaticDir = PublicDir = "static"
DefaultSubdirs = ["coffee", "views", StaticDir]

class SwagrCommand < Thor

  include Thor::Actions

  def self.source_root
    SwagrSourceRoot
  end

  desc "upgrade", "Upgrade used libs by re-downloading the latest versions of needed libs. Might brake some of your code so use with caution."
  def upgrade
    inside File.join(SwagrSourceRoot, "templates", PublicDir, "js") do
      get "http://d3js.org/d3.v3.min.js"
      get "http://coffeescript.org/extras/coffee-script.js"
      get "http://code.jquery.com/jquery-latest.js"
    end
  end

  desc "init DIR", "Create (or update) a skeleton structure in DIR for customizing a swagr app. You should carefully review and answer the question it poses if you have updated any of the standard files. If not you risk losing your changes."
  def init(dir)
    empty_directory dir
    inside dir do
      DefaultSubdirs.each {|subdir| empty_directory(subdir)}
    end
    # Now copy everything in the templates dir into the 
    directory "templates", dir
  end

  desc "create DIR", "Create/setup a swagr app in DIR"
  def create(dir)
    init(dir)
    public_dir = File.join(dir, PublicDir)
    tarball = File.join(public_dir, "skeleton.zip")
    copy_file SkeletonTarball, tarball
    inside public_dir do
      run "unzip skeleton.zip"
      FileUtils.rm_rf "skeleton.zip"
      say "Removed tarball"
    end
  end

end

SwagrCommand.start